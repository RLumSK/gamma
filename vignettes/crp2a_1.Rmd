---
title: "CRP2A Calibration Curve #1"
subtitle: "Canberra Inspector 1000 - LaBr"
author: "CRP2A Luminescence Team"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{CRP2A#1}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  fig.width = 7,
  fig.height = 5,
  comment = "#>"
)
```

```{r packages}
library(gamma)
library(magrittr)
```

## Import files
```{r import}
# Import CNF files for calibration
# Skip the first chanels
calib_dir <- system.file("extdata/crp2a/calibration", package = "gamma")
(calib_spc <- read(calib_dir, skip = TRUE))

# Import CNF files for background noise measurement
# Skip the first chanels
noise_dir <- system.file("extdata/crp2a/background", package = "gamma")
(noise_spc <- read(noise_dir, skip = TRUE))
```

## Inspect spectra
```{r inspect, fig.align='center'}
# Plot calibration spectra
plot(calib_spc, xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "Reference spectra") +
  ggplot2::theme_bw()

# Plot background noise spectrum
plot(noise_spc) +
  ggplot2::labs(title = "Background noise spectrum") +
  ggplot2::theme_bw()
```

## Energy scale calibration
### Reference spectra
Lines used for energy scale calibration (in keV):

* Pb212: 238
* K40: 1461
* Tl208: 2615

#### BRIQUE
```{r calib-BRIQUE}
plot(calib_spc[["BRIQUE"]], xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "BRIQUE") +
  ggplot2::theme_bw()
```

#### C341
```{r calib-C341}
plot(calib_spc[["C341"]], xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "C341") +
  ggplot2::theme_bw()
```

#### C347
```{r calib-C347}
plot(calib_spc[["C347"]], xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "C347") +
  ggplot2::theme_bw()
```

#### GOU
```{r calib-GOU}
plot(calib_spc[["GOU"]], xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "GOU") +
  ggplot2::theme_bw()
```

#### LMP
```{r calib-LMP}
plot(calib_spc[["LMP"]], xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "LMP") +
  ggplot2::theme_bw()
```

#### MAZ
```{r calib-MAZ}
plot(calib_spc[["MAZ"]], xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "MAZ") +
  ggplot2::theme_bw()
```

#### PEP
```{r calib-PEP}
plot(calib_spc[["PEP"]], xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "PEP") +
  ggplot2::theme_bw()
```

### Background noise spectrum
```{r calibrate-noise, fig.align='center'}
plot(noise_spc) +
  ggplot2::labs(title = "Background noise spectrum") +
  ggplot2::theme_bw()
```

## Calibration curve
### Summary
```{r calibration, fig.width=5, fig.height=5, fig.align='center'}
data("BDX1")

# Plot Calibration curve
plot(BDX1) +
  ggplot2::theme_bw()
```

```{r lm-summary, echo=FALSE}
# Slope: 31.16884 / Intercept: 2006.62935
summary(BDX1[["model"]])
```

```{r save, eval=FALSE, echo=FALSE, include=FALSE}
# Danger zone ! Don't touch !
# usethis::use_data(BDX1, overwrite = FALSE)
```

### Check model
```{r lm-check, echo=FALSE, out.width='47%', fig.width=3.5, fig.height=3.5, fig.show='hold'}
calib_residuals <- data.frame(
  reference = BDX1[["data"]]$reference,
  fitted = BDX1[["model"]]$fitted.values,
  residuals = BDX1[["model"]]$residuals,
  standardized = stats::rstandard(BDX1[["model"]]),
  cook = stats::cooks.distance(BDX1[["model"]]),
  stringsAsFactors = FALSE
)

# Residuals vs fitted values
ggplot2::ggplot(calib_residuals, ggplot2::aes(x = fitted, y = residuals)) +
  ggplot2::geom_hline(yintercept = 0, linetype = 3) +
  ggplot2::geom_segment(ggplot2::aes(x = fitted, xend = fitted,
                                     y = 0, yend = residuals)) + 
  ggplot2::geom_point() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Residuals vs fitted values",
                x = "Fitted values", y = "Residuals")

# Std. residuals vs fitted values
ggplot2::ggplot(calib_residuals, ggplot2::aes(x = fitted, y = standardized)) +
  ggplot2::geom_hline(yintercept = 0, linetype = 3) +
  ggplot2::geom_hline(yintercept = c(-2, 2), linetype = 2) +
  ggplot2::geom_segment(ggplot2::aes(x = fitted, xend = fitted,
                                     y = 0, yend = standardized)) + 
  ggplot2::geom_point() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Std. residuals vs fitted values",
                x = "Fitted values", y = "Standardized residuals")

# Normal QQ plot of standardized residuals
ggplot2::ggplot(calib_residuals, ggplot2::aes(sample = standardized)) +
  ggplot2::geom_abline(slope = 1, intercept = 0) +
  ggplot2::geom_qq_line(colour = "red") +
  ggplot2::geom_qq() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Normal QQ plot",
                x = "Theoretical quantiles",
                y = "Standardize residuals")

# Cook's distance
ggplot2::ggplot(calib_residuals, ggplot2::aes(x = reference, y = cook)) +
  ggplot2::geom_hline(yintercept = 0, linetype = 3) +
  ggplot2::geom_hline(yintercept = 1, linetype = 2) +
  ggplot2::geom_segment(ggplot2::aes(x = reference, xend = reference,
                                     y = 0, yend = cook)) +
  ggplot2::geom_point() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Cook's distance",
                x = "Observation", y = "D")
```

```{r test-old-compare, echo=FALSE, eval=FALSE}
# The smaller the AIC or BIC, the better the fit
criterion_aic <- c(stats::AIC(BDX1[["model"]]))
criterion_bic <- c(stats::BIC(BDX1[["model"]]))

criteria <- data.frame(
  AIC = criterion_aic,
  D_AIC = criterion_aic - min(criterion_aic),
  BIC = criterion_bic,
  row.names = c("New curve (BDX1)", "Old curve (VBA macro)")
)

knitr::kable(
  criteria,
  digits = 3,
  col.names = c("AIC", "\u0394i", "BIC"),
  caption = "Information Criterion"
)
```

## R session
```{r session-info, echo=FALSE}
sessionInfo()
```
