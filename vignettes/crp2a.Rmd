---
title: "CRP2A Calibration Curve For Gamma Dose Rate Estimate"
subtitle: "Canberra Inspector 1000"
author:
- "N. Frerebeau"
- "G. Guérin"
- "C. Lahaye"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{crp2a}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(gamma)
library(ggplot2)
library(magrittr)
```

## Import files
```{r import}
# Import CNF files for calibration
# Skip the 30 first chanels
crp2a_cnf <- system.file("extdata/crp2a/", package = "gamma")
crp2a_spc <- read(crp2a_cnf, skip = TRUE)
crp2a_spc

# Select 'BRIQUE', 'C341', 'C347', 'GOU', 'LMP', 'MAZ' and 'PEP' to build the curve
crp2a_calib <- crp2a_spc[c("BRIQUE", "C341", "C347", "GOU", "LMP", "MAZ", "PEP")]
# Select 'BDF' spectra for background noise measurement
crp2a_noise <- crp2a_spc[["BDF"]]
```

```{r inspect, fig.width=7, fig.height=5, fig.align="center"}
# Plot spectra
plot(crp2a_calib, yaxis = "rate") +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Count rate [1/s]") +
  ggplot2::theme_bw()

plot(crp2a_noise, yaxis = "rate") +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Count rate [1/s]") +
  ggplot2::theme_bw()
```

## Check baseline
```{r baseline-calib, fig.width=7, fig.height=9, fig.align="center"}
# Remove base line
calib_clean <- removeBaseline(crp2a_calib)

plot(calib_clean, yaxis = "rate", facet = TRUE) +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Count rate [1/s]") +
  ggplot2::theme_bw()
```

```{r baseline-noise, fig.width=7, fig.height=5, fig.align="center"}
# Remove base line
noise_clean <- removeBaseline(crp2a_noise, LLS = TRUE, k = 10)

plot(noise_clean, yaxis = "rate") +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Count rate [1/s]") +
  ggplot2::theme_bw()
```

## Peak detection
```{r peak}
# Fit peaks at 238, 1461, 2614.5 keV (starting positions)
calib_peaks <- lapply(X = crp2a_calib, FUN = fitPeaks, 
                      peaks = c(238, 1461, 2614.5), scale = "energy",
                      bound = c(0.5, 0.5, 0.5))
```

```{r peak-fit, echo=FALSE, fig.width=7, fig.height=5, fig.align="center", results="asis"}
# Visual inspection
expected_peaks <- c(238, 1461, 2614.5)

for (i in 1:length(calib_peaks)) {
  print(
    plot(calib_peaks[[i]]) +
      ggplot2::labs(title = calib_peaks[[i]][["spectrum"]][["reference"]], 
                    x = "Energy [keV]", y = "Counts") +
      ggplot2::theme_bw()
  )
  
  crp2a_pks <- calib_peaks[[i]][["peaks"]] %>%
      dplyr::mutate(shift = (energy - expected_peaks) * 100 / 
                      abs(expected_peaks))
  
  print(
    knitr::kable(
      crp2a_pks,
      digits = 3,
      col.names = c("Chanel", "Energy [keV]", "Count", 
                    "Count rate [1/s]", "Energy error [%]"),
      caption = calib_peaks[[i]][["spectrum"]][["reference"]]
    )
  )
  cat('\n')
}
```

```{r peak-noise, fig.width=7, fig.height=5, fig.align="center"}
# Fit peaks
noise_peaks <- fitPeaks(crp2a_noise, peaks = c(1461, 2614.5), scale = "energy",
                        LLS = TRUE, k = 10)
plot(noise_peaks)
```

## Energy calibration
```{r calibrate-spc, fig.width=7, fig.height=5, fig.align="center"}
calib_scale <- lapply(X = calib_peaks, FUN = calibrateEnergy, 
                      lines = c(238, 1461, 2614.5))
calib_scale <- methods::as(calib_scale, "GammaSpectra")

plot(calib_scale, yaxis = "rate") +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Count rate [1/s]") +
  ggplot2::theme_bw()
```

Le spectre pour la mesure de bruit est particulièrement bruité, la recherche automatique de pics ne peut pas aboutir. On va donc forcer les canaux a utiliser pour la calibration en énergie.
```{r calibrate-noise, fig.width=7, fig.height=5, fig.align="center"}
noise_lines <- list(
  Pb = c(chanel = 76, energy = 238),
  K = c(chanel = 459, energy = 1461),
  Cs = c(chanel = 816, energy = 2614.5)
)
kk <- as.data.frame(do.call(rbind, noise_lines))
rownames(kk) <- NULL

noise_scale <- calibrateEnergy(crp2a_noise, lines = noise_lines)

plot(crp2a_noise, noise_scale) +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Count") +
  ggplot2::theme_bw()
```

## Signal integration
```{r integrate-noise}
noise <- integrateSignal(crp2a_noise, range = c(165, 2800), noise = NULL, 
                         NiEi = TRUE)
noise
```

```{r integrate-spc}
signal <- integrateSignal(calib_scale, range = c(165, 2800), noise = noise, 
                          NiEi = TRUE)
do.call(rbind, signal)
```

## Build Calibration curve
### Linear regression
```{r calibration, fig.width=5, fig.height=5, fig.align="center"}
# Build calibration curve
crp2a_dose <- list(
  BRIQUE = c(1986, 36),
  C341 = c(850, 21),
  C347 = c(1424, 24),
  GOU = c(1575, 17),
  LMP = c(642, 18),
  MAZ = c(1141, 12),
  PEP = c(2538, 112)
)

CRP2A <- calibrateDose(
  crp2a_calib,
  dose = crp2a_dose,
  noise = noise,
  range = c(165, 2800),
  intercept = TRUE,
  details = list(laboratory = "IRAMAT-CRP2A",
                 instrument = "InSpector 1000")
)

# Plot Calibration curve
plot(CRP2A) +
  ggplot2::labs(x = "Signal", y = "Dose rate [µGy/y]") +
  ggplot2::theme_bw()
```

```{r save, eval=FALSE, echo=FALSE, include=FALSE}
usethis::use_data(CRP2A, overwrite = FALSE)
```

### Model checking
```{r lm-summary, echo=FALSE}
summary(CRP2A@model)
```

```{r lm-check, echo=FALSE, warning=FALSE, fig.width=7, fig.height=7, fig.align="center"}
calib_residuals <- data.frame(
  fitted = CRP2A[["model"]]$fitted.values,
  residuals = CRP2A[["model"]]$residuals,
  standardized = stats::rstandard(CRP2A[["model"]])
)

# Normal QQ plot of standardized residuals
qq_plot <- ggplot2::ggplot(calib_residuals, 
                           ggplot2::aes(sample = standardized)) + 
  ggplot2::geom_abline(slope = 1, intercept = 0) +
  ggplot2::geom_qq_line(colour = "red") +
  ggplot2::geom_qq() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Normal QQ plot",
                x = "Theoretical quantiles",
                y = "Standardize residuals")

# Residuals vs fitted values
res_plot <- ggplot2::ggplot(calib_residuals, 
                            ggplot2::aes(x = fitted, y = residuals)) +
  ggplot2::geom_hline(yintercept = 0, linetype = 3) +
  ggplot2::geom_segment(ggplot2::aes(x = fitted, xend = fitted,
                                     y = 0, yend = residuals)) + 
  ggplot2::geom_point() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Residuals vs fitted values",
                x = "Fitted values", y = "Residuals")

# Relative error on dose rate estimation
dose_rate <- estimateDoseRate(calib_scale, CRP2A, range = c(165, 2800))

dose_calc <- as(dose_rate, "data.frame") %>%
  dplyr::select(-signal, -signal_error) %>%
  dplyr::rename(dose_calc = dose, error_calc = dose_error)

dose_err <- do.call(rbind, crp2a_dose) %>%
  as.data.frame() %>%
  magrittr::set_colnames(c("dose_exp", "error_exp")) %>%
  dplyr::mutate(reference = rownames(.)) %>%
  dplyr::full_join(dose_calc, ., by = "reference") %>%
  dplyr::mutate(rel_error = (dose_calc - dose_exp) / dose_exp)

err_plot <- ggplot2::ggplot(dose_err, ggplot2::aes(x = reference, y = rel_error * 100)) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::labs(title = "Relative error",
                x = "Reference", y = "Relative error [%]") +
  ggplot2::theme_bw()

cowplot::plot_grid(
  qq_plot, res_plot, err_plot,
  ncol = 2, labels = "AUTO"
)
```

## R session
```{r session-info, echo=FALSE}
sessionInfo()
```
