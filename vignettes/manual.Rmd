---
title: "Manual"
author:
- "N. Frerebeau"
- "B. Lebrun"
- "G. Guérin"
- "C. Lahaye"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{Manual}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(gamma)
library(magrittr)
```

## Overview

`gamma` is intended to process in-situ gamma-ray spectrometry measurements for luminescence dating. This package allows to import, inspect and (automatically) correct the energy scale of the spectrum. It provides methods for estimating the gamma dose rate by the use of a calibration curve. This package only supports Canberra CNF and TKA files.

Typical workflow:

1. Import spectrum data with `read()`
2. Inspect spectrum with `plot()`
3. Calibrate the energy scale with `calibrate()`
4. Estimate the gamma dose rate with `predict()`

## Import file
```{r import, fig.width=7, fig.height=5, fig.align="center"}
# Import a CNF file
cnf_test <- system.file("extdata/test.cnf", package = "gamma")
(spc_cnf <- read(cnf_test))

# Import a TKA file
tka_test <- system.file("extdata/test.tka", package = "gamma")
(spc_tka <- read(tka_test))

# Import all files in a given directory
files_test <- system.file("extdata/", package = "gamma")
(spc <- read(files_test))
```

## Inspect spectrum
```{r inspect, fig.width=7, fig.height=5, fig.align="center"}
# Plot spectra
plot(spc, xaxis = "chanel", yaxis = "rate", facet = TRUE) +
  ggplot2::theme_bw()
```

```{r import-skip, fig.width=7, fig.height=5, fig.align="center"}
# Import a file and skip the first chanels
(spc_tka <- read(tka_test, skip = 1:35))

(spc_cnf <- read(cnf_test, skip = TRUE))

# Plot spectra
plot(spc_cnf) +
  ggplot2::theme_bw()
```

## Calibrate the energy scale
### Estimate and remove baseline
Algorithme SNIP [@ryan1988; @morhac1997; @morhac2008]

```{r baseline-estimate, fig.width=7, fig.height=5, fig.align="center"}
# Estimate baseline
baseline <- estimateBaseline(spc_cnf, method = "SNIP")

# Plot spectrum + baseline
plot(spc_cnf, baseline, xaxis = "energy", yaxis = "count") +
  ggplot2::theme_bw()
```

```{r baseline-remove, fig.width=7, fig.height=5, fig.align="center"}
# Substract previously estimated baseline
spc_clean1 <- spc_cnf - baseline
# Or, you can just remove baseline from spectrum
spc_clean2 <- removeBaseline(spc_cnf, method = "SNIP")

identical(spc_clean1, spc_clean2)

# Plot spectra
plot(spc_clean1) +
  ggplot2::theme_bw()
```

### Automatic peak detection
On peut tenter de détecter automatiquement les pics présents dans le spectre.
Un pic est identifié comme tel s'il y a changement de signe de la courbe dans une fenêtre donnée et si la valeur est supérieure a `SNR` fois le rapport signal sur bruit.

Le vrai problème reside dans le choix de la fenêtre (en nombre de canaux) pour la recherche de pics.
Si `span = NULL` la demi-fenêtre de recherche est fixée à 5% du nombre de canaux.

```{r peak-detection, fig.width=7, fig.height=5, fig.align="center", fig.show="hold"}
# Detect peaks
peak_index <- findPeaks(spc_cnf)

# Get peak positions
knitr::kable(
  peak_index[["peaks"]],
  digits = 3,
  col.names = c("Chanel", "Energy [keV]", "Count", "Count rate [1/s]"),
  caption = "Automatic peak detection"
)

# Plot spectrum
plot(peak_index) +
  ggplot2::theme_bw()
```

### Peak parameters estimation
Comme le spectre est bruité, il peut y avoir un léger décalage entre la position du pic identifié automatiquement et la valeur attendue. Pour améliorer ça, on ajuste des gaussiennes aux positions souhaitées et on en récupère les paramètres. La position du pic retenue est alors la valeur du spectre la plus proche de la moyenne de la gaussienne correspondante.

On peut ajuster des gaussiennes directement à partir des résultats de l'étape précédente (détection automatique) ou spécifier les positions de départ.

Si les pics sont trop rapprochés ou le signal trop bruité, la première solution peut ne pas aboutir (problème de convergence lors de l'ajustement des gaussiennes). Dans la mesure où on est interessé par seulement trois pics (238, 1461, 2614.5 keV), la seconde approche produit de meilleurs résultats (et réduit le temps de calcul).

Dans tous les cas, mieux vaut vérifier visuellement les résultats après.

```{r peak-fit-auto, fig.width=7, fig.height=5, fig.align="center"}
# Fit peaks found by automatic detection
peak_fit_auto <- fitPeaks(peak_index)

plot(peak_fit_auto) +
  ggplot2::labs(title = "Peak parameters estimate") +
  ggplot2::theme_bw()
```

```{r peak-fit-manual, fig.width=7, fig.height=5, fig.align="center"}
# Fit peaks at a given chanel
peak_fit_chanel <- fitPeaks(spc_clean1, peaks = c(86, 496, 876))

## Plot results
plot(peak_fit_chanel) +
  ggplot2::labs(title = "Fixed peak positions (chanel)") +
  ggplot2::theme_bw()

## Get peak positions
knitr::kable(
  peak_fit_chanel[["coefficients"]],
  digits = 3,
  col.names = c("Mean (chanel)", "Std. dev. (chanel)", "Height (count)"),
  caption = "Peak positions"
)
```

### Energy scale calibration
```{r calibrate}
calib_lines <- list(
  Pb = c(chanel = 86, energy = 238),
  K = c(chanel = 493, energy = 1461),
  Cs = c(chanel = 876, energy = 2614.5)
)

tka_scale <- calibrate(spc_tka, lines = calib_lines)

plot(tka_scale) +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::theme_bw()
```

## Gamma dose rate estimation
### Signal integration
```{r integrate}
(tka_int1 <- integrateSignal(tka_scale, range = c(200, 2800),
                             noise = NULL))

(tka_int2 <- integrateSignal(tka_scale, range = c(200, 2800), 
                             noise = c(1114.769, 0.5378)))
```

### Dose Rate
```{r dose-rate, eval=FALSE, fig.width=7, fig.height=5, fig.align="center"}
# Calibrate energy scale
cnf_scale <- calibrate(spc_cnf, lines = calib_lines)

# Visual inspection
plot(spc_cnf, cnf_scale) +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Count") +
  ggplot2::theme_bw()

# Estimate dose rate
dose_rate <- predict(cnf_scale, calib_curve)
as(dose_rate, "data.frame")
```

## References
