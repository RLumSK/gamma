---
title: "Vignette Title"
author: "N. Frerebeau, B. Lebrun"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{manual}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(gamma)
library(magrittr)
```

## Spectrum inspection
### Import a CNF file
```{r import, fig.width=7, fig.height=5, fig.align="center"}
# Import CNF files for calibration
cnf_test <- system.file("extdata/test1.cnf", package = "gamma")
spc <- read(cnf_test)
spc

# Plot spectra
plot(spc, select = NULL) +
  ggplot2::labs(x = "Energy [keV]", y = "Counts") +
  ggplot2::theme_bw()
```

### Estimate and remove background
Algorithme SNIP [@ryan1988; @morhac1997]

```{r baseline, fig.width=7, fig.height=5, fig.align="center"}
# Estimate baseline
baseline <- estimateBaseline(spc, method = c("SNIP"))

# Plot spectrum + baseline
plot(spc) +
  ggplot2::geom_line(colour = "red", data = baseline,
                     mapping = ggplot2::aes(x = energy, y = baseline))

# Remove baseline
spc_clean <- removeBaseline(spc)

# Plot spectra
plot(spc_clean, select = NULL) +
  ggplot2::labs(x = "Energy [keV]", y = "Counts") +
  ggplot2::theme_bw()
```

Remarque : le choix du nombre d'itérations de SNIP pour l'estimation de la ligne de fond n'a visiblement pas d'incidence.

```{r baseline-repeat, echo=FALSE, eval=FALSE, fig.width=7, fig.height=5, fig.align="center"}
# Number of iterations
iter <- c(25, 50, 100, 200, 400)
# Estimate baseline
baseline_iter <- lapply(
  X = iter, 
  FUN = function(i, spectrum) {
    removeBaseline(spectrum, method = c("SNIP"), k = i)
  },
  spectrum = spc
)
baseline_scp <- new("GammaSpectra", baseline_iter)

# Plot spectrum + baseline
plot(baseline_scp, select = NULL) +
  ggplot2::labs(x = "Energy [keV]", y = "Counts") +
  ggplot2::theme_bw()
```

### Detect peaks
Le vrai problème reside dans le choix de la fenêtre pour la recherche de pics.
Si `span = NULL` la demi-fenêtre de recherche est fixée à 5% du nombre de canaux.

```{r peaks, fig.width=7, fig.height=5, fig.align="center"}
# Detect peaks
peak_index <- findPeaks(spc_clean, span = NULL)

plot(spc_clean, select = 1:3, facet = TRUE) +
  ggplot2::labs(x = "Energy [keV]", y = "Counts") +
  ggplot2::geom_vline(xintercept = peak_index$energy, colour = "red") +
  ggplot2::theme_bw()
```

## Gamma dose rate estimation
### Import files
```{r import-calib, fig.width=7, fig.height=5, fig.align="center"}
# Import CNF files for calibration
cnf_cerege <- system.file("extdata/cerege/", package = "gamma")
spc_cerege <- read(cnf_cerege)
spc_cerege

# Plot spectra
plot(spc_cerege, select = NULL) +
  ggplot2::labs(x = "Energy [keV]", y = "Counts") +
  ggplot2::theme_bw()
```

### Background noise measurement
Cette étape n'est pas optimale. Par la suite on utilise la valeur de bruit de fond estimée à la main (1190 +/- 1).
```{r background-noise, fig.width=7, fig.height=5, fig.align="center"}
# Select 'PB' spectra for background measurement
spc_PB <- spc_cerege[["PB"]]

# Plot spectrum
plot(spc_PB) +
  ggplot2::labs(x = "Energy [keV]", y = "Counts") +
  ggplot2::theme_bw()

# Integrate background noise between 200 keV and 2800 keV
noise <- integrateSignal(spc_PB, peaks = c(238, 1461, 2614.5), span = 100)
noise
```

### Build Calibration curve
Attention : la fenetre de recherche de pics est fixée à 20 ci-après. La valeur automatique entraine une mauvaise indexation sur un des spectres.

```{r calibration-curve, fig.width=5, fig.height=5, fig.align="center"}
# Select 'BRIQUE', 'C341', 'C347', 'GOU' and 'PEB' spectra to build the curve
spc_calib <- spc_cerege[c("BRIQUE", "C341", "C347", "GOU", "PEB")]
  
# Build calibration curve
known_dose <- list(
  BRIQUE = c(1984.64, 34.08),
  C347 = c(1421.38, 25.25),
  C341 = c(849.01, 21.32),
  PEP = c(2535.53, 112.17),
  GOU = c(1573.41, 17.43)
)

calib_curve <- calibrate(
  spc_calib,
  dose = known_dose,
  noise = list(value = 1190, error = 1),
  span = 20
)
calib_curve

# Plot Calibration curve
plot(calib_curve) +
  ggplot2::labs(x = "Dose rate [µGy/y]", y = "Signal") +
  # ggplot2::geom_label(nudge_x = 50, nudge_y = -750) +
  ggplot2::theme_bw()
```

### Gamma dose rate estimation
```{r dose-rate, fig.width=7, fig.height=5, fig.align="center"}
# Import CNF file for dose rate estimation
spc_dir <- system.file("extdata/test1.cnf", package = "gamma")
spc_test <- read(spc_dir)

# Plot spectrum
plot(spc_test) +
  ggplot2::labs(x = "Energy [keV]", y = "Counts") +
  ggplot2::theme_bw()

dose_rate <- estimateDoseRate(spc_test, calib_curve, 
                              noise = list(value = 1190, error = 1),
                              span = 20)
as(dose_rate, "data.frame")
```

## References
