---
title: "CEREGE Calibration Curve"
author: "N. Frerebeau, B. Lebrun"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{cerege}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(gamma)
library(magrittr)
```

## Import files
```{r import, fig.width=7, fig.height=5, fig.align="center"}
# Import CNF files for calibration
# Skip the 35 first chanels
cerege_cnf <- system.file("extdata/cerege/", package = "gamma")
cerege_spc <- read(cerege_cnf, skip = 1:35)
cerege_spc

# Select 'BRIQUE', 'C341', 'C347', 'GOU' and 'PEB' spectra to build the curve
cerege_calib <- cerege_spc[c("BRIQUE", "C341", "C347", "GOU", "PEP")]
# Select 'PB' spectra for background measurement
cerege_noise <- cerege_spc[["PB"]]

# Plot spectra
plot(cerege_calib) +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Counts") +
  ggplot2::theme_bw()
```

## Check automatic peak detection
```{r peak}
# Remove base line
cerege_clean <- removeBaseline(cerege_calib)

# Fit peaks
cerege_fit <- lapply(X = cerege_clean, FUN = fitPeaks, peaks = c(238, 1461, 2614.5))
```

```{r peak-fit, fig.width=7, fig.height=5, fig.align="center", results="asis"}
# Visual inspection
expected_peaks <- c(238, 1461, 2614.5)

for (i in 1:length(cerege_fit)) {
  print(
    plot(cerege_fit[[i]]) +
      ggplot2::labs(title = cerege_fit[[i]][["spectrum"]][["reference"]], 
                    x = "Energy [keV]", y = "Counts") +
      ggplot2::theme_bw()
  )
  
  cerege_pks <- cerege_fit[[i]][["peaks"]] %>%
      dplyr::mutate(shift = (energy - expected_peaks) * 100 / 
                      abs(expected_peaks))
  
  print(
    knitr::kable(
      cerege_pks,
      digits = 3,
      col.names = c("Chanel", "Energy [keV]", "Count", 
                    "Count rate [1/s]", "Energy error [%]"),
      caption = cerege_fit[[i]][["spectrum"]][["reference"]]
    )
  )
  cat('\n')
}
```

## Check energy calibration
```{r calibrate, fig.width=7, fig.height=5, fig.align="center"}
calib_lines <- list(
  Pb = c(86, 238),
  K = c(493, 1461),
  Cs = c(876, 2614.5)
)

cerege_scale <- calibrateEnergy(cerege_calib, lines = calib_lines)

plot(cerege_scale) +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Count") +
  ggplot2::theme_bw()
```

## Background noise measurement
Le spectre pour la mesure de bruit est particulièrement bruité, la recherche automatique de pics ne peut pas aboutir.
On va donc forcer les canaux a utiliser pour la calibration en énergie.

```{r background-noise, fig.width=7, fig.height=5, fig.align="center"}
calib_noise <- list(
  Pb = c(86, 238),
  K = c(492, 1461),
  Cs = c(866, 2614.5)
)

cerege_noise_scale <- calibrateEnergy(cerege_noise, lines = calib_noise, force = TRUE)

plot(cerege_noise_scale) +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2614.5), linetype = 3) +
  ggplot2::labs(x = "Energy [keV]", y = "Count") +
  ggplot2::theme_bw()
```

Une fois la calibration en énergie faite, on peut intégrer le spectre.
```{r integrate-noise}
noise <- integrateSignal(cerege_noise_scale)
noise
```

## Build Calibration curve
```{r calibration, fig.width=5, fig.height=5, fig.align="center"}
# Build calibration curve
cerege_dose <- list(
  BRIQUE = c(1984.64, 34.08),
  C347 = c(1421.38, 25.25),
  C341 = c(849.01, 21.32),
  PEP = c(2535.53, 112.17),
  GOU = c(1573.41, 17.43)
)

CEREGE <- calibrateDose(
  cerege_scale,
  dose = cerege_dose,
  noise = noise
)
CEREGE

# Plot Calibration curve
plot(CEREGE) +
  ggplot2::labs(x = "Signal", y = "Dose rate [µGy/y]") +
  ggplot2::theme_bw()
```

```{r save, eval=FALSE, echo=FALSE, include=FALSE}
usethis::use_data(CEREGE, overwrite = FALSE)
```
