---
title: "CEREGE Calibration Curve #1"
subtitle: "Canberra Inspector 1000 - NaI"
author: "CEREGE Luminescence Team"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
header-includes:
   - \usepackage{amsmath}
   - \usepackage{amssymb}
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{CEREGE#1}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  message = FALSE,
  fig.width = 7,
  fig.height = 5,
  fig.align = "center",
  comment = "#>"
)
library(gamma)
library(magrittr)
```

## Import files
```{r import}
# Import CNF files for calibration
# Skip the first chanels
calib_dir <- system.file("extdata/cerege/calibration", package = "gamma")
(calib_spc <- read(calib_dir, skip = TRUE))

# Import CNF files for background noise measurement
# Skip the first chanels
noise_dir <- system.file("extdata/cerege/background", package = "gamma")
(noise_spc <- read(noise_dir, skip = TRUE))
```

## Inspect spectra
```{r inspect}
# Plot calibration spectra
plot(calib_spc, xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "Calibration spectra") +
  ggplot2::theme_bw()

# Plot background noise spectrum
plot(noise_spc) +
  ggplot2::labs(title = "Background noise spectrum") +
  ggplot2::theme_bw()
```

## Energy scale calibration
### Reference spectra
Lines used for energy scale calibration (in keV):

* Pb212: 238 (85)
* K40: 1461 (495)
* Tl208: 2615 (870)

#### BRIQUE
```{r calib-BRIQUE}
# Spectrum pre-processing and peak detection
pks <- calib_spc[["BRIQUE"]] %>%
  smooth(method = "savitzky", m = 21) %>%
  removeBaseline(decreasing = TRUE, k = 100) %>%
  findPeaks()
# Set energy values
setEnergy(pks) <- c(238, NA, NA, NA, 1461, NA, 2615)
# Recalibrate the energy scale
BRIQUE <- calibrate(calib_spc[["BRIQUE"]], pks)
```

#### C341
```{r calib-C341}
# Spectrum pre-processing and peak detection
pks <- calib_spc[["C341"]] %>%
  smooth(method = "savitzky", m = 21) %>%
  removeBaseline(decreasing = TRUE, k = 100) %>%
  findPeaks(span = 20)
# Set energy values
setEnergy(pks) <- c(NA, 238, NA, NA, NA, NA, NA, 1461, 2615)
# Recalibrate the energy scale
C341 <- calibrate(calib_spc[["C341"]], pks)
```

#### C347
```{r calib-C347}
# Spectrum pre-processing and peak detection
pks <- calib_spc[["C347"]] %>%
  smooth(method = "savitzky", m = 21) %>%
  removeBaseline(decreasing = TRUE, k = 100) %>%
  findPeaks(SNR = 1, span = 20)
# Set energy values
setEnergy(pks) <- c(NA, 238, NA, NA, NA, NA, NA, 1461, NA, NA, NA, 2615)
# Recalibrate the energy scale
C347 <- calibrate(calib_spc[["C347"]], pks)
```

#### GOU
```{r calib-GOU}
# Spectrum pre-processing and peak detection
pks <- calib_spc[["GOU"]] %>%
  smooth(method = "savitzky", m = 21) %>%
  removeBaseline(decreasing = TRUE, k = 100) %>%
  findPeaks(span = 20)
# Set energy values
setEnergy(pks) <- c(NA, 238, NA, NA, NA, NA, 1461, 2615)
# Recalibrate the energy scale
GOU <- calibrate(calib_spc[["GOU"]], pks)
```

#### PEP
```{r calib-PEP}
# Spectrum pre-processing and peak detection
pks <- calib_spc[["PEP"]] %>%
  smooth(method = "savitzky", m = 21) %>%
  removeBaseline(decreasing = TRUE, k = 100) %>%
  findPeaks(span = 20)
# Set energy values
setEnergy(pks) <- c(NA, 238, NA, NA, NA, NA, 1461, NA, 2615)
# Recalibrate the energy scale
PEP <- calibrate(calib_spc[["PEP"]], pks)
```

#### Inspect results
```{r calib-scale}
# Energy scale calibration
calib_scaled <- list(BRIQUE, C341, C347, GOU, PEP)
calib_scaled <- methods::as(calib_scaled, "GammaSpectra")

plot(calib_scaled, xaxis = "energy", yaxis = "rate") +
  ggplot2::labs(title = "Calibrated spectra") +
  ggplot2::theme_bw()
```

### Background noise spectrum
```{r calibrate-noise}
noise_lines <- list(
  Pb212 = c(chanel = 86, energy = 238),
  K40 = c(chanel = 496, energy = 1461),
  Tl208 = c(chanel = 870, energy = 2615)
)
noise_scaled <- calibrate(noise_spc, lines = noise_lines)

plot(noise_spc, noise_scaled, xaxis = "energy", yaxis = "rate") +
  ggplot2::geom_vline(xintercept = c(238, 1461, 2615), linetype = 3) +
  ggplot2::theme_bw()
```

## Signal integration
### Get integration boudaries
```{r integrate-bounds}
# Integration range (in keV)
integration_range <- c(200, 2800)
```

### Integrate
```{r integrate-norm}
# Integrate background noise
noise <- integrateSignal(
  noise_scaled,
  range = integration_range,
  NiEi = TRUE
)

# Integrate reference spectra
signal <- integrateSignal(
  calib_scaled, 
  range = integration_range, 
  noise = noise,
  NiEi = TRUE,
  simplify = TRUE
)
```

```{r integrate-results, echo=FALSE}
knitr::kable(
  rbind(rbind(noise), signal),
  digits = 3,
  caption = "Spectra integration"
)
```

## Build Calibration curve
### Set dose rates
```{r dose_rate}
data("clermont")
setDoseRate(calib_scaled) <- clermont[, c("gamma", "gamma_error")]

getDoseRate(calib_scaled)
```

### Linear regression
```{r calibration, fig.width=5, fig.height=5, fig.align="center"}
# Build calibration curve
(AIX1 <- fit(
  calib_scaled,
  noise_scaled,
  range = integration_range,
  intercept = TRUE,
  details = list(
    laboratory = "CEREGE",
    instrument = "InSpector 1000",
    detector = "NaI",
    authors = "CEREGE Luminescence Team"
  )
))

# Plot Calibration curve
plot(AIX1) +
  ggplot2::theme_bw()
```

```{r save, eval=FALSE, echo=FALSE, include=FALSE}
# Danger zone ! Don't touch !
usethis::use_data(AIX1, overwrite = FALSE)
```

### Check model
```{r lm-summary, echo=FALSE}
summary(AIX1[["model"]])
```

```{r lm-check, echo=FALSE, warning=FALSE, fig.width=7, fig.height=7, fig.align="center"}
calib_residuals <- data.frame(
  reference = AIX1[["data"]]$reference,
  fitted = AIX1[["model"]]$fitted.values,
  residuals = AIX1[["model"]]$residuals,
  standardized = stats::rstandard(AIX1[["model"]]),
  cook = stats::cooks.distance(AIX1[["model"]])
)

# Residuals vs fitted values
plot_res <- ggplot2::ggplot(calib_residuals, 
                            ggplot2::aes(x = fitted, y = residuals)) +
  ggplot2::geom_hline(yintercept = 0, linetype = 3) +
  ggplot2::geom_segment(ggplot2::aes(x = fitted, xend = fitted,
                                     y = 0, yend = residuals)) + 
  ggplot2::geom_point() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Residuals vs fitted values",
                x = "Fitted values", y = "Residuals")

# Std. residuals vs fitted values
plot_stdres <- ggplot2::ggplot(calib_residuals, 
                               ggplot2::aes(x = fitted, y = standardized)) +
  ggplot2::geom_hline(yintercept = 0, linetype = 3) +
  ggplot2::geom_hline(yintercept = c(-2, 2), linetype = 2) +
  ggplot2::geom_segment(ggplot2::aes(x = fitted, xend = fitted,
                                     y = 0, yend = standardized)) + 
  ggplot2::geom_point() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Std. residuals vs fitted values",
                x = "Fitted values", y = "Standardized residuals")

# Normal QQ plot of standardized residuals
plot_qq <- ggplot2::ggplot(calib_residuals, 
                           ggplot2::aes(sample = standardized)) + 
  ggplot2::geom_abline(slope = 1, intercept = 0) +
  ggplot2::geom_qq_line(colour = "red") +
  ggplot2::geom_qq() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Normal QQ plot",
                x = "Theoretical quantiles",
                y = "Standardize residuals")

# Cook's distance
plot_cook <- ggplot2::ggplot(calib_residuals, 
                             ggplot2::aes(x = reference, y = cook)) +
  ggplot2::geom_hline(yintercept = 0, linetype = 3) +
  ggplot2::geom_hline(yintercept = 1, linetype = 2) +
  ggplot2::geom_segment(ggplot2::aes(x = reference, xend = reference,
                                     y = 0, yend = cook)) + 
  ggplot2::geom_point() +
  ggplot2::theme_bw() +
  ggplot2::labs(title = "Cook's distance",
                x = "Observation", y = "D")

cowplot::plot_grid(
  plot_res, plot_stdres, plot_cook, plot_qq,
  ncol = 2, labels = "AUTO"
)
```

```{r test-old-compare, echo=FALSE}
criteria <- data.frame(
  AIC = c(stats::AIC(AIX1[["model"]])),
  BIC = c(stats::BIC(AIX1[["model"]])),
  row.names = c("AIX1")
)

knitr::kable(
  criteria,
  digits = 3,
  caption = "Information Criterion"
)
```

## R session
```{r session-info, echo=FALSE}
sessionInfo()
```
